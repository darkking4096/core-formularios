<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Core Distribuidora - Venda Fisica</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; color: #fff; }
        .header h1 { font-size: 28px; margin-bottom: 10px; color: #3498db; }
        .header p { color: #bdc3c7; }
        .form-card { background: #1e293b; border-radius: 15px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); margin-bottom: 20px; }
        .section-title { font-size: 18px; font-weight: 600; color: #e2e8f0; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #3498db; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #cbd5e1; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 15px; border: 2px solid #475569; border-radius: 8px; font-size: 15px; background: #0f172a; color: #e2e8f0; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #3498db; }
        .form-group textarea { resize: vertical; min-height: 60px; background: #0f172a; color: #e2e8f0; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-row-3 { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; }
        .item-card { background: #0f172a; border: 2px solid #3498db; border-radius: 12px; padding: 20px; margin-bottom: 15px; position: relative; }
        .item-card.acessorio { border-color: #9b59b6; background: #1a1030; }
        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .item-number { font-weight: 700; font-size: 16px; color: #e2e8f0; }
        .btn-remove { background: #e74c3c; color: #fff; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: background 0.3s; }
        .btn-remove:hover { background: #c0392b; }
        .btn-add { background: #3498db; color: #fff; border: none; padding: 12px 25px; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: background 0.3s; margin-bottom: 20px; width: 100%; }
        .btn-add:hover { background: #2980b9; }
        .btn-add.acessorio { background: #9b59b6; }
        .btn-add.acessorio:hover { background: #8e44ad; }
        .btn-add.pagamento { background: #f39c12; }
        .btn-add.pagamento:hover { background: #e67e22; }
        .pagamento-card { background: #1a1700; border: 2px solid #f39c12; border-radius: 12px; padding: 20px; margin-bottom: 15px; }
        .pagamento-card.troca { border-color: #e74c3c; background: #1a0505; }
        .pagamento-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .pagamento-title { font-weight: 600; color: #e2e8f0; }
        .troca-fields { display: none; margin-top: 15px; padding-top: 15px; border-top: 2px dashed #e74c3c; }
        .troca-fields.show { display: block; }
        .taxa-info { background: #332b00; border: 1px solid #ffc107; border-radius: 8px; padding: 10px 15px; margin-top: 10px; font-size: 13px; color: #ffd54f; }
        .taxa-info.green { background: #0a2e14; border-color: #28a745; color: #66bb6a; }
        .resumo { background: #2c3e50; border-radius: 12px; padding: 20px; color: #fff; margin-top: 20px; }
        .resumo-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; color: #3498db; }
        .resumo-section { margin-bottom: 15px; }
        .resumo-section-title { font-size: 13px; color: #95a5a6; text-transform: uppercase; margin-bottom: 8px; }
        .resumo-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #34495e; font-size: 14px; }
        .resumo-item:last-child { border-bottom: none; }
        .resumo-item .label { color: #bdc3c7; }
        .resumo-total { font-size: 20px; font-weight: 700; color: #2ecc71; margin-top: 10px; padding-top: 10px; border-top: 2px solid #3498db; display: flex; justify-content: space-between; }
        .resumo-taxas { font-size: 14px; color: #e74c3c; margin-top: 5px; }
        .btn-submit { background: #27ae60; color: #fff; border: none; padding: 18px 40px; border-radius: 10px; font-size: 18px; font-weight: 700; cursor: pointer; width: 100%; transition: background 0.3s; margin-top: 20px; }
        .btn-submit:hover { background: #219a52; }
        .btn-submit:disabled { background: #95a5a6; cursor: not-allowed; }
        .alert { padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { display: none; text-align: center; padding: 20px; }
        .loading.show { display: block; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e0e0e0; border-top-color: #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hint { color: #94a3b8; margin-bottom: 15px; font-size: 14px; }
        @media (max-width: 600px) { .form-row, .form-row-3 { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Venda Fisica</h1>
            <p>Core Distribuidora - Venda Rapida (sem recibo)</p>
        </div>
        <div class="form-card">
            <div class="alert alert-success" id="alertSuccess"></div>
            <div class="alert alert-error" id="alertError"></div>
            <form id="formVenda">
                <div class="section-title">Data da Venda</div>
                <div class="form-group">
                    <label>Data *</label>
                    <input type="date" id="dataVenda" required>
                </div>

                <div class="section-title">Aparelhos</div>
                <p class="hint">Informe o codigo do produto no estoque (ex: AP001-001)</p>
                <div id="aparelhosContainer"></div>
                <button type="button" class="btn-add" onclick="adicionarAparelho()">+ Adicionar Aparelho</button>

                <div class="section-title">Acessorios Brinde (opcional)</div>
                <p class="hint">Informe o codigo do acessorio se houver brinde</p>
                <div id="acessoriosContainer"></div>
                <button type="button" class="btn-add acessorio" onclick="adicionarAcessorio()">+ Adicionar Acessorio Brinde</button>

                <div class="section-title">Pagamento</div>
                <p class="hint">Informe o valor cobrado do cliente. A taxa sera descontada automaticamente.</p>
                <div id="pagamentosContainer"></div>
                <button type="button" class="btn-add pagamento" onclick="adicionarPagamento()">+ Adicionar Forma de Pagamento</button>

                <div class="resumo" id="resumo" style="display: none;">
                    <div class="resumo-title">Resumo da Venda</div>
                    <div id="resumoContent"></div>
                </div>

                <div class="loading" id="loading"><div class="spinner"></div><p>Registrando venda...</p></div>
                <button type="submit" class="btn-submit" id="btnSubmit">REGISTRAR VENDA</button>
            </form>
        </div>
    </div>

    <script>
        const WEBHOOK_URL = 'https://n8neditor.coofe.online/webhook/venda-fisica';
        let aparelhoCount = 0, acessorioCount = 0, pagamentoCount = 0;

        const TAXAS = {
            'Dinheiro': 0, 'PIX': 0, 'PIX QR Code': 0.99, 'Debito': 1.69,
            'Credito': {1:3.89,2:5.51,3:6.27,4:7.02,5:7.77,6:8.53,7:9.78,8:10.53,9:11.29,10:12.04,11:12.80,12:13.55,13:14.49,14:15.25,15:16.00,16:16.75,17:17.51,18:18.26}
        };

        function getTaxaPercent(forma, parcelas) {
            if (!forma || forma === 'TROCA') return 0;
            if (forma === 'Dinheiro' || forma === 'PIX') return 0;
            if (forma === 'PIX QR Code') return 0.99;
            if (forma === 'Debito') return 1.69;
            if (forma === 'Credito') return TAXAS.Credito[parseInt(parcelas) || 1] || 3.89;
            return 0;
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('dataVenda').value = new Date().toISOString().split('T')[0];
            adicionarAparelho();
            adicionarPagamento();
        });

        // ---- APARELHOS ----
        function adicionarAparelho() {
            aparelhoCount++;
            const html = `
                <div class="item-card" id="aparelho-${aparelhoCount}" data-index="${aparelhoCount}">
                    <div class="item-header">
                        <span class="item-number">Aparelho #${aparelhoCount}</span>
                        ${aparelhoCount > 1 ? `<button type="button" class="btn-remove" onclick="removerAparelho(${aparelhoCount})">x</button>` : ''}
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Codigo do Produto *</label>
                            <input type="text" id="codAparelho-${aparelhoCount}" placeholder="Ex: AP001-001" oninput="this.value=this.value.toUpperCase();calcularResumo()">
                        </div>
                        <div class="form-group">
                            <label>Preco Base de Venda (R$) *</label>
                            <input type="number" id="precoAparelho-${aparelhoCount}" min="0" step="0.01" placeholder="0.00" oninput="calcularResumo()">
                        </div>
                    </div>
                </div>`;
            document.getElementById('aparelhosContainer').insertAdjacentHTML('beforeend', html);
        }
        function removerAparelho(i) { document.getElementById(`aparelho-${i}`)?.remove(); calcularResumo(); }

        // ---- ACESSORIOS ----
        function adicionarAcessorio() {
            acessorioCount++;
            const html = `
                <div class="item-card acessorio" id="acessorio-${acessorioCount}" data-index="${acessorioCount}">
                    <div class="item-header">
                        <span class="item-number">Acessorio #${acessorioCount}</span>
                        <button type="button" class="btn-remove" onclick="removerAcessorio(${acessorioCount})">x</button>
                    </div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>Codigo do Acessorio</label>
                            <input type="text" id="codAcessorio-${acessorioCount}" placeholder="Ex: AC001" oninput="this.value=this.value.toUpperCase();calcularResumo()">
                        </div>
                        <div class="form-group">
                            <label>Quantidade</label>
                            <input type="number" id="qtdAcessorio-${acessorioCount}" min="1" value="1" oninput="calcularResumo()">
                        </div>
                        <div class="form-group">
                            <label>Valor Exibido (R$)</label>
                            <input type="number" id="precoAcessorio-${acessorioCount}" min="0" step="0.01" placeholder="0.00" oninput="calcularResumo()">
                        </div>
                    </div>
                </div>`;
            document.getElementById('acessoriosContainer').insertAdjacentHTML('beforeend', html);
        }
            document.getElementById('acessoriosContainer').insertAdjacentHTML('beforeend', html);
        }
        function removerAcessorio(i) { document.getElementById(`acessorio-${i}`)?.remove(); calcularResumo(); }

        // ---- PAGAMENTOS ----
        function adicionarPagamento() {
            pagamentoCount++;
            const idx = pagamentoCount;
            const html = `
                <div class="pagamento-card" id="pagamento-${idx}" data-index="${idx}">
                    <div class="pagamento-header">
                        <span class="pagamento-title">Pagamento #${idx}</span>
                        ${idx > 1 ? `<button type="button" class="btn-remove" onclick="removerPagamento(${idx})">x</button>` : ''}
                    </div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>Forma *</label>
                            <select id="forma-${idx}" onchange="onFormaChange(${idx})">
                                <option value="">Selecione...</option>
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="PIX">PIX</option>
                                <option value="PIX QR Code">PIX QR Code</option>
                                <option value="Debito">Debito</option>
                                <option value="Credito">Credito</option>
                                <option value="TROCA">TROCA (Aparelho)</option>
                            </select>
                        </div>
                        <div class="form-group" id="parcelasGroup-${idx}" style="display:none;">
                            <label>Parcelas</label>
                            <select id="parcelas-${idx}" onchange="calcularResumo()">
                                ${Array.from({length:18}, (_, i) => `<option value="${i+1}">${i+1}x</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group" id="valorGroup-${idx}">
                            <label>Valor Cobrado (R$) *</label>
                            <input type="number" id="valorBase-${idx}" min="0" step="0.01" placeholder="0.00" oninput="calcularResumo()">
                        </div>
                    </div>
                    <div class="taxa-info" id="taxaInfo-${idx}" style="display:none;"></div>

                    <div class="troca-fields" id="trocaFields-${idx}">
                        <div class="section-title" style="border-color:#e74c3c; color:#e74c3c;">Aparelho de Troca</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Marca *</label>
                                <select id="trocaMarca-${idx}" onchange="calcularResumo()">
                                    <option value="">Selecione...</option>
                                    <option value="Xiaomi">Xiaomi</option>
                                    <option value="Samsung">Samsung</option>
                                    <option value="Apple">Apple</option>
                                    <option value="Motorola">Motorola</option>
                                    <option value="Realme">Realme</option>
                                    <option value="Poco">Poco</option>
                                    <option value="Redmi">Redmi</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Modelo/Versao *</label>
                                <input type="text" id="trocaModelo-${idx}" placeholder="Ex: Galaxy S23">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Capacidade *</label>
                                <select id="trocaCapacidade-${idx}">
                                    <option value="">Selecione...</option>
                                    <option value="32GB">32GB</option>
                                    <option value="64GB">64GB</option>
                                    <option value="128GB">128GB</option>
                                    <option value="256GB">256GB</option>
                                    <option value="512GB">512GB</option>
                                    <option value="1TB">1TB</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Cor *</label>
                                <input type="text" id="trocaCor-${idx}" placeholder="Ex: Preto">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Codigo (opcional)</label>
                                <input type="text" id="trocaCodigo-${idx}" placeholder="Ex: AP005" oninput="this.value=this.value.toUpperCase()">
                            </div>
                            <div class="form-group">
                                <label>Valor da Troca (R$) *</label>
                                <input type="number" id="trocaPreco-${idx}" min="0" step="0.01" placeholder="0.00" oninput="calcularResumo()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Observacao sobre o aparelho de troca</label>
                            <textarea id="trocaObs-${idx}" placeholder="Ex: Tela com trinca pequena, bateria 80%"></textarea>
                        </div>
                    </div>
                </div>`;
            document.getElementById('pagamentosContainer').insertAdjacentHTML('beforeend', html);
            calcularResumo();
        }
        function removerPagamento(i) { document.getElementById(`pagamento-${i}`)?.remove(); calcularResumo(); }

        function onFormaChange(idx) {
            const forma = document.getElementById(`forma-${idx}`).value;
            const card = document.getElementById(`pagamento-${idx}`);
            const parcelasGroup = document.getElementById(`parcelasGroup-${idx}`);
            const trocaFields = document.getElementById(`trocaFields-${idx}`);
            const valorGroup = document.getElementById(`valorGroup-${idx}`);

            parcelasGroup.style.display = forma === 'Credito' ? 'block' : 'none';
            
            if (forma === 'TROCA') {
                trocaFields.classList.add('show');
                card.classList.add('troca');
                valorGroup.style.display = 'none';
            } else {
                trocaFields.classList.remove('show');
                card.classList.remove('troca');
                valorGroup.style.display = 'block';
            }
            calcularResumo();
        }

        // ---- RESUMO ----
        function calcularResumo() {
            const resumoDiv = document.getElementById('resumo');
            const content = document.getElementById('resumoContent');
            let html = '';

            // Aparelhos
            let totalPrecoBase = 0;
            const aparelhosHtml = [];
            document.querySelectorAll('[id^="aparelho-"]').forEach(card => {
                const i = card.dataset.index;
                const cod = document.getElementById(`codAparelho-${i}`)?.value?.trim() || '';
                const preco = parseFloat(document.getElementById(`precoAparelho-${i}`)?.value) || 0;
                if (cod && preco > 0) {
                    totalPrecoBase += preco;
                    aparelhosHtml.push(`<div class="resumo-item"><span>${cod}</span><span>R$ ${preco.toFixed(2)}</span></div>`);
                }
            });

            // Acessorios brinde
            const acessoriosHtml = [];
            document.querySelectorAll('[id^="acessorio-"]').forEach(card => {
                const i = card.dataset.index;
                const cod = document.getElementById(`codAcessorio-${i}`)?.value?.trim() || '';
                const qtd = parseInt(document.getElementById(`qtdAcessorio-${i}`)?.value) || 1;
                const preco = parseFloat(document.getElementById(`precoAcessorio-${i}`)?.value) || 0;
                if (cod) {
                    const precoText = preco > 0 ? `R$ ${preco.toFixed(2)} (brinde)` : 'brinde';
                    acessoriosHtml.push(`<div class="resumo-item"><span class="label">${cod} (${qtd}x)</span><span>${precoText}</span></div>`);
                }
            });

            // Pagamentos
            let totalCobrado = 0, taxaTotal = 0, trocaTotal = 0;
            const pagHtml = [];
            const trocaHtml = [];

            document.querySelectorAll('[id^="pagamento-"]').forEach(card => {
                const i = card.dataset.index;
                const forma = document.getElementById(`forma-${i}`)?.value;
                if (!forma) return;

                if (forma === 'TROCA') {
                    const trocaPreco = parseFloat(document.getElementById(`trocaPreco-${i}`)?.value) || 0;
                    const trocaMarca = document.getElementById(`trocaMarca-${i}`)?.value || '';
                    const trocaModelo = document.getElementById(`trocaModelo-${i}`)?.value || '';
                    trocaTotal += trocaPreco;
                    if (trocaPreco > 0) {
                        trocaHtml.push(`<div class="resumo-item"><span class="label">${trocaMarca} ${trocaModelo}</span><span>R$ ${trocaPreco.toFixed(2)}</span></div>`);
                        pagHtml.push(`<div class="resumo-item"><span>TROCA</span><span>R$ ${trocaPreco.toFixed(2)}</span></div>`);
                    }
                    // Update taxa info
                    const infoEl = document.getElementById(`taxaInfo-${i}`);
                    if (infoEl) { infoEl.style.display = 'none'; }
                } else {
                    const valorBase = parseFloat(document.getElementById(`valorBase-${i}`)?.value) || 0;
                    const parcelas = document.getElementById(`parcelas-${i}`)?.value;
                    const taxaPct = getTaxaPercent(forma, parcelas);
                    const taxaValor = valorBase * (taxaPct / 100);
                    const valorRecebido = valorBase - taxaValor;

                    taxaTotal += taxaValor;
                    totalCobrado += valorBase;

                    const infoEl = document.getElementById(`taxaInfo-${i}`);
                    if (infoEl && valorBase > 0) {
                        if (taxaPct > 0) {
                            infoEl.style.display = 'block';
                            infoEl.className = 'taxa-info';
                            const parcelasText = forma === 'Credito' ? ` ${parcelas}x` : '';
                            infoEl.innerHTML = `<strong>${forma}${parcelasText}</strong>: R$ ${valorBase.toFixed(2)} - ${taxaPct}% taxa = <strong>R$ ${valorRecebido.toFixed(2)}</strong> recebido` +
                                (forma === 'Credito' ? ` (${parcelas}x de R$ ${(valorBase / parseInt(parcelas)).toFixed(2)} p/ cliente)` : '');
                        } else {
                            infoEl.style.display = 'block';
                            infoEl.className = 'taxa-info green';
                            infoEl.innerHTML = `<strong>${forma}</strong>: R$ ${valorBase.toFixed(2)} (sem taxa)`;
                        }
                    } else if (infoEl) { infoEl.style.display = 'none'; }

                    if (valorBase > 0) {
                        const label = forma === 'Credito' ? `Credito ${parcelas}x` : forma;
                        pagHtml.push(`<div class="resumo-item"><span>${label}: R$ ${valorBase.toFixed(2)} - taxa</span><span>R$ ${valorBase.toFixed(2)}</span></div>`);
                    }
                }
            });

            const totalGeralCobrado = totalCobrado + trocaTotal;

            if (aparelhosHtml.length > 0 || pagHtml.length > 0) {
                html += `<div class="resumo-section"><div class="resumo-section-title">Aparelhos</div>${aparelhosHtml.join('')}</div>`;
                if (acessoriosHtml.length > 0) html += `<div class="resumo-section"><div class="resumo-section-title">Acessorios Brinde</div>${acessoriosHtml.join('')}</div>`;
                html += `<div class="resumo-section"><div class="resumo-section-title">Pagamento</div>${pagHtml.join('')}</div>`;
                if (trocaHtml.length > 0) html += `<div class="resumo-section"><div class="resumo-section-title">Aparelho(s) de Troca</div>${trocaHtml.join('')}</div>`;
                html += `<div class="resumo-total"><span>TOTAL COBRADO:</span><span>R$ ${totalGeralCobrado.toFixed(2)}</span></div>`;
                if (taxaTotal > 0) html += `<div class="resumo-taxas">Taxa total maquina: -R$ ${taxaTotal.toFixed(2)}</div>`;

                resumoDiv.style.display = 'block';
                content.innerHTML = html;
            } else {
                resumoDiv.style.display = 'none';
            }
        }

        // ---- SUBMIT ----
        document.getElementById('formVenda').addEventListener('submit', async function(e) {
            e.preventDefault();
            const dataVenda = document.getElementById('dataVenda').value;

            // Coletar aparelhos
            const aparelhos = [];
            document.querySelectorAll('[id^="aparelho-"]').forEach(card => {
                const i = card.dataset.index;
                const cod = document.getElementById(`codAparelho-${i}`)?.value?.trim().toUpperCase();
                const preco = parseFloat(document.getElementById(`precoAparelho-${i}`)?.value) || 0;
                if (cod && preco > 0) aparelhos.push({ codigo: cod, precoVenda: preco });
            });
            if (aparelhos.length === 0) { alert('Adicione pelo menos um aparelho'); return; }

            // Coletar acessorios
            const acessorios = [];
            document.querySelectorAll('[id^="acessorio-"]').forEach(card => {
                const i = card.dataset.index;
                const cod = document.getElementById(`codAcessorio-${i}`)?.value?.trim().toUpperCase();
                const qtd = parseInt(document.getElementById(`qtdAcessorio-${i}`)?.value) || 1;
                const precoVenda = parseFloat(document.getElementById(`precoAcessorio-${i}`)?.value) || 0;
                if (cod) acessorios.push({ codigo: cod, quantidade: qtd, precoVenda: precoVenda });
            });

            // Coletar pagamentos
            const pagamentos = [];
            const trocas = [];
            let temPagamentoValido = false;

            document.querySelectorAll('[id^="pagamento-"]').forEach(card => {
                const i = card.dataset.index;
                const forma = document.getElementById(`forma-${i}`)?.value;
                if (!forma) return;

                if (forma === 'TROCA') {
                    const marca = document.getElementById(`trocaMarca-${i}`)?.value;
                    const modelo = document.getElementById(`trocaModelo-${i}`)?.value;
                    const capacidade = document.getElementById(`trocaCapacidade-${i}`)?.value;
                    const cor = document.getElementById(`trocaCor-${i}`)?.value;
                    const codigo = document.getElementById(`trocaCodigo-${i}`)?.value?.trim().toUpperCase() || '';
                    const preco = parseFloat(document.getElementById(`trocaPreco-${i}`)?.value) || 0;
                    const obs = document.getElementById(`trocaObs-${i}`)?.value || '';

                    if (!marca || !modelo || !capacidade || !cor || preco <= 0) {
                        alert(`Pagamento #${i}: Preencha todos os campos do aparelho de troca`);
                        throw new Error('validation');
                    }
                    trocas.push({ marca, modelo, capacidade, cor, codigo, preco, observacao: obs });
                    pagamentos.push({ forma: 'TROCA', valorBase: preco, taxaPct: 0, taxaValor: 0, totalCobrado: preco, parcelas: '' });
                    temPagamentoValido = true;
                } else {
                    const valorBase = parseFloat(document.getElementById(`valorBase-${i}`)?.value) || 0;
                    const parcelas = forma === 'Credito' ? document.getElementById(`parcelas-${i}`)?.value : '';

                    if (valorBase <= 0) return;
                    if (forma === 'Credito' && !parcelas) { alert(`Pagamento #${i}: Selecione parcelas para credito`); throw new Error('validation'); }

                    const taxaPct = getTaxaPercent(forma, parcelas);
                    const taxaValor = Math.round(valorBase * (taxaPct / 100) * 100) / 100;
                    const totalCobrado = valorBase;

                    pagamentos.push({ forma, parcelas: parcelas || '', valorBase, taxaPct, taxaValor, totalCobrado });
                    temPagamentoValido = true;
                }
            });

            if (!temPagamentoValido) { alert('Adicione pelo menos um pagamento'); return; }

            const payload = { dataVenda, aparelhos, acessorios, pagamentos, trocas };

            document.getElementById('loading').classList.add('show');
            document.getElementById('btnSubmit').disabled = true;
            document.getElementById('alertSuccess').style.display = 'none';
            document.getElementById('alertError').style.display = 'none';

            try {
                const response = await fetch(WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                if (response.ok && result.success) {
                    document.getElementById('alertSuccess').style.display = 'block';
                    document.getElementById('alertSuccess').textContent = result.message || 'Venda registrada!';
                    // Reset
                    document.getElementById('aparelhosContainer').innerHTML = '';
                    document.getElementById('acessoriosContainer').innerHTML = '';
                    document.getElementById('pagamentosContainer').innerHTML = '';
                    aparelhoCount = 0; acessorioCount = 0; pagamentoCount = 0;
                    adicionarAparelho(); adicionarPagamento();
                    document.getElementById('resumo').style.display = 'none';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else { throw new Error(result.error || result.message || 'Erro ao processar'); }
            } catch (error) {
                if (error.message !== 'validation') {
                    document.getElementById('alertError').style.display = 'block';
                    document.getElementById('alertError').textContent = 'Erro: ' + error.message;
                }
            } finally {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('btnSubmit').disabled = false;
            }
        });
    </script>
</body>
</html>
